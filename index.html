<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat치logo de Pedidos</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #25D366; /* WhatsApp Green */
            --dark: #075E54;
            --light: #f0f2f5;
            --text: #333;
            --card-bg: #fff;
        }

        * { box-sizing: border-box; }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--light); color: var(--text); margin: 0; padding-bottom: 100px; }
        
        /* Header & Search */
        header { background: var(--dark); color: white; padding: 1rem; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h1 { margin: 0 0 10px 0; font-size: 1.2rem; text-align: center; }
        input#search { width: 100%; padding: 12px; border-radius: 25px; border: none; font-size: 16px; padding-left: 20px; outline: none; }

        /* Grid de Productos */
        .container { max-width: 1200px; margin: 0 auto; padding: 10px; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        
        @media (min-width: 768px) {
            .grid { grid-template-columns: repeat(4, 1fr); gap: 15px; }
        }

        .card { background: var(--card-bg); padding: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; flex-direction: column; justify-content: space-between; height: 100%; }
        .card h3 { margin: 0 0 5px 0; font-size: 0.9rem; color: var(--dark); line-height: 1.2; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .sku { font-size: 0.75rem; color: #888; margin-bottom: 5px; }
        .price { font-size: 1.1rem; font-weight: bold; color: var(--text); margin-bottom: 8px; }
        
        .add-btn { background: var(--dark); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold; font-size: 0.9rem; transition: background 0.2s; }
        .add-btn:active { transform: scale(0.98); background: var(--primary); }
        .add-btn:hover { background: #0a7c6e; }

        /* Footer Flotante (Carrito) */
        .fab-cart { 
            position: fixed; 
            bottom: 20px; 
            right: 20px; 
            background: var(--primary); 
            color: white; 
            padding: 15px 25px; 
            border-radius: 50px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); 
            cursor: pointer; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: bold; 
            z-index: 1000; 
            transition: transform 0.2s; 
        }
        
        /* Mobile FAB adjustments */
        @media (max-width: 600px) {
            .fab-cart {
                bottom: 15px;
                left: 15px;
                right: 15px;
                border-radius: 12px;
                justify-content: space-between;
                padding: 15px 20px;
            }
        }

        .fab-cart:hover { transform: scale(1.02); }
        .hidden { display: none; }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 95%; max-width: 500px; max-height: 90vh; overflow-y: auto; border-radius: 15px; padding: 20px; position: relative; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 28px; cursor: pointer; color: #666; z-index: 10; }
        
        /* Formulario y Lista Pedido */
        .order-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .order-item div:first-child { flex: 1; padding-right: 10px; }
        .total-row { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.2rem; margin-top: 15px; padding-top: 15px; border-top: 2px solid var(--dark); color: var(--dark); }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: #555; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .form-group input:focus { border-color: var(--primary); outline: none; }
        
        .whatsapp-btn { background: var(--primary); color: white; width: 100%; border: none; padding: 15px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .whatsapp-btn:hover { background: #1ebc57; }
        
        .remove-item { color: #ff4444; font-weight: bold; margin-left: 15px; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>

<header>
    <h1>Farmacia/Droguer칤a - Pedidos</h1>
    <input type="text" id="search" placeholder="游댌 Buscar producto...">
</header>

<div class="container">
    <div id="product-list" class="grid">
        <p style="text-align:center; grid-column: 1/-1;">Cargando lista de precios...</p>
    </div>
</div>

<div id="cart-fab" class="fab-cart hidden" onclick="openModal()">
    <span>游 Ver Pedido</span>
    <span id="cart-total">$0</span>
</div>

<div id="checkout-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <h2>Tu Pedido</h2>
        <div id="order-summary"></div>
        <div class="total-row">
            <span>Total Estimado:</span>
            <span id="modal-total">$0</span>
        </div>

        <hr style="margin: 20px 0;">
        
        <h3>Datos de Env칤o</h3>
        <form id="order-form" onsubmit="sendToWhatsapp(event)">
            <div class="form-group">
                <label>Nombre Completo</label>
                <input type="text" id="name" required>
            </div>
            <div class="form-group">
                <label>Direcci칩n de Entrega</label>
                <input type="text" id="address" required>
            </div>
            <div class="form-group">
                <label>Tel칠fono</label>
                <input type="tel" id="phone" required>
            </div>
            <div class="form-group">
                <label>Email (Opcional)</label>
                <input type="email" id="email">
            </div>
            <button type="submit" class="whatsapp-btn">Enviar Pedido por WhatsApp 游</button>
        </form>
    </div>
</div>

<script>
    // --- CONFIGURACI칍N ---
    // TU N칔MERO DE WHATSAPP (Formato Internacional sin +)
    // Ejemplo: 5491112345678 (Argentina celular)
    const MY_PHONE_NUMBER = "5491100000000"; 
    
    let products = [];
    let cart = {};

    // 1. Cargar Excel
    fetch('lista_precios.xlsx')
        .then(response => {
            if (!response.ok) throw new Error("No se pudo cargar el archivo");
            return response.arrayBuffer();
        })
        .then(data => {
            parseExcel(data);
        })
        .catch(error => {
            document.getElementById('product-list').innerHTML = 
                '<p style="color:red; text-align:center;">Error cargando lista de precios.<br>Verifica que el archivo "lista_precios.xlsx" exista.</p>';
            console.error('Error:', error);
        });

    function parseExcel(data) {
        const workbook = XLSX.read(data, {type: 'array'});
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        // Convertir a array de arrays (fila por fila)
        const rows = XLSX.utils.sheet_to_json(worksheet, {header: 1});
        
        const listContainer = document.getElementById('product-list');
        listContainer.innerHTML = ''; // Limpiar loader

        // Empezamos en i=1 para saltar el encabezado
        for (let i = 1; i < rows.length; i++) {
            const row = rows[i];
            if (!row || row.length === 0) continue;
            
            // Asumimos columnas: [0] C칩digo, [1] Nombre, [2] Precio
            const code = row[0] ? String(row[0]).trim() : '';
            const name = row[1] ? String(row[1]).trim() : '';
            let priceRaw = row[2];
            
            if (code && name && priceRaw != null) {
                let price = 0;
                let priceStr = '';

                if (typeof priceRaw === 'number') {
                    price = priceRaw;
                } else {
                    // Convertir "2018,94" a n칰mero
                    let pStr = String(priceRaw).replace(',', '.').replace('$', '').trim();
                    price = parseFloat(pStr);
                }

                if (isNaN(price)) price = 0;
                priceStr = price.toLocaleString('es-AR', {minimumFractionDigits: 2});
                
                products.push({ code, name, price });
                
                // Crear HTML
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.name = name.toLowerCase();
                card.dataset.code = code.toLowerCase();
                card.innerHTML = `
                    <div>
                        <div class="sku">C칩d: ${code}</div>
                        <h3>${name}</h3>
                    </div>
                    <div>
                        <div class="price">$${priceStr}</div>
                        <button class="add-btn" onclick="addToCart('${code}')">AGREGAR +</button>
                    </div>
                `;
                listContainer.appendChild(card);
            }
        }
    }

    // 2. Buscador
    document.getElementById('search').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const cards = document.querySelectorAll('.card');
        
        cards.forEach(card => {
            const match = card.dataset.name.includes(term) || card.dataset.code.includes(term);
            card.style.display = match ? 'flex' : 'none';
        });
    });

    // 3. L칩gica del Carrito
    function addToCart(code) {
        if (!cart[code]) {
            cart[code] = 1;
        } else {
            cart[code]++;
        }
        updateCartUI();
    }

    function removeFromCart(code) {
        delete cart[code];
        updateCartUI();
        renderOrderSummary(); // Actualizar modal si est치 abierto
    }

    function updateCartUI() {
        const fab = document.getElementById('cart-fab');
        let total = 0;
        let count = 0;

        for (const [code, qty] of Object.entries(cart)) {
            const product = products.find(p => p.code === code);
            if (product) {
                total += product.price * qty;
                count += qty;
            }
        }

        document.getElementById('cart-total').innerText = `$${total.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
        
        if (count > 0) fab.classList.remove('hidden');
        else fab.classList.add('hidden');
    }

    // 4. Modal y Checkout
    function openModal() {
        renderOrderSummary();
        document.getElementById('checkout-modal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('checkout-modal').style.display = 'none';
    }

    function renderOrderSummary() {
        const container = document.getElementById('order-summary');
        container.innerHTML = '';
        let total = 0;

        for (const [code, qty] of Object.entries(cart)) {
            const product = products.find(p => p.code === code);
            if (product) {
                const subtotal = product.price * qty;
                total += subtotal;
                
                container.innerHTML += `
                    <div class="order-item">
                        <div>
                            <strong>${product.name}</strong><br>
                            <small>${qty} x $${product.price.toLocaleString('es-AR')}</small>
                        </div>
                        <div>
                            $${subtotal.toLocaleString('es-AR')}
                            <span class="remove-item" onclick="removeFromCart('${code}')">X</span>
                        </div>
                    </div>
                `;
            }
        }
        
        if (total === 0) closeModal(); // Cerrar si se vac칤a
        document.getElementById('modal-total').innerText = `$${total.toLocaleString('es-AR', {minimumFractionDigits: 2})}`;
    }

    // 5. Enviar a WhatsApp
    function sendToWhatsapp(e) {
        e.preventDefault();
        
        const name = document.getElementById('name').value;
        const address = document.getElementById('address').value;
        const phone = document.getElementById('phone').value;
        const email = document.getElementById('email').value;

        let message = `*NUEVO PEDIDO WEB*\n`;
        message += `------------------\n`;
        message += `游녻 *Cliente:* ${name}\n`;
        message += `游늸 *Direcci칩n:* ${address}\n`;
        message += `游 *Tel:* ${phone}\n`;
        if(email) message += `九괦잺 *Email:* ${email}\n`;
        message += `------------------\n`;
        message += `*DETALLE DEL PEDIDO:*\n`;

        let total = 0;
        for (const [code, qty] of Object.entries(cart)) {
            const product = products.find(p => p.code === code);
            if (product) {
                const subtotal = product.price * qty;
                total += subtotal;
                message += `郊쀮잺 ${product.name} (x${qty})\n`;
            }
        }
        
        message += `------------------\n`;
        message += `游눯 *TOTAL ESTIMADO: $${total.toLocaleString('es-AR', {minimumFractionDigits: 2})}*`;

        const url = `https://wa.me/${MY_PHONE_NUMBER}?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    }

    // Cerrar modal al hacer click fuera
    window.onclick = function(event) {
        const modal = document.getElementById('checkout-modal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>

</body>
</html>